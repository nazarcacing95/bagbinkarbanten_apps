<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard SDM Polda Banten</title>

    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        /* --- DASHBOARD CORE STYLES --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #0f172a;
            /* Dark background for particles */
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden;
            /* Prevent body scroll, handle in main */
            display: flex;
            height: 100vh;
        }

        /* Particle Canvas */
        #particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9));
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(245, 158, 11, 0.2);
            /* Amber border */
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 50;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo-box {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #fbbf24, #d97706);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
            animation: pulse-logo 3s infinite;
        }

        @keyframes pulse-logo {

            0%,
            100% {
                transform: scale(1);
                filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.5));
            }

            50% {
                transform: scale(1.1);
                filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.8));
            }
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            color: #94a3b8;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fbbf24;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.1), transparent);
            border-left: 4px solid #fbbf24;
            color: #fbbf24;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            position: relative;
            z-index: 10;
            overflow-y: auto;
            padding: 40px;
        }

        /* --- APP ISOALTION STYLES --- */
        .app-view {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .app-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* UNIFIED APP CARD STYLE */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            margin: 0 auto;
        }

        /* --- APP 1: UKP OVERRIDES --- */
        #app-ukp {
            font-family: 'Poppins', sans-serif;
            max-width: 600px;
            margin: 0 auto;
        }

        #app-ukp .app-card {
            @apply glass-card;
            width: 100%;
        }

        #app-ukp .header {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 4px solid #fbbf24;
        }

        #app-ukp button {
            background: linear-gradient(to right, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            transition: 0.3s;
        }

        #app-ukp button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        #app-ukp .content {
            padding: 30px;
        }

        #app-ukp .form-group {
            margin-bottom: 20px;
        }

        #app-ukp label {
            color: #b45309;
            font-weight: 800;
            font-size: 12px;
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
        }

        #app-ukp select,
        #app-ukp input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #fed7aa;
            background: #fff7ed;
            color: #431407;
            outline: none;
            transition: 0.3s;
        }

        #app-ukp select:focus,
        #app-ukp input:focus {
            border-color: #f59e0b;
            background: #fff;
        }

        /* --- APP 2: VALIDATOR OVERRIDES --- */
        #app-validator {
            max-width: 1200px;
            margin: 0 auto;
        }

        #app-validator .glass-card {
            @apply glass-card;
        }

        #app-validator header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
            border-bottom: 4px solid #f59e0b !important;
        }

        #app-validator .icon-box {
            background: #d97706 !important;
        }

        #app-validator .stat-card {
            border-bottom: 4px solid #f59e0b !important;
        }

        #app-validator .btn-orange {
            @apply bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold shadow-lg shadow-orange-500/30 hover:scale-105 transition-all;
        }

        /* --- APP 3: INDIKATOR OVERRIDES --- */
        #app-indikator {
            max-width: 800px;
            margin: 0 auto;
            font-family: 'Segoe UI', sans-serif;
            color: #ffffff !important;
            /* Force white text globally for this app */
        }

        #app-indikator .card {
            background: rgba(15, 23, 42, 0.8) !important;
            /* Darker background */
            backdrop-filter: blur(12px);
            padding: 30px;
            border-top: 8px solid #d97706;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #app-indikator h2 {
            color: #ffffff !important;
            /* Force white header */
            text-align: center;
            font-weight: 800;
            font-size: 24px;
            margin-bottom: 30px;
            letter-spacing: 1px;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        #app-indikator label {
            color: #ffffff !important;
            /* Force white labels */
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 8px;
            display: block;
            letter-spacing: 0.5px;
        }

        #app-indikator button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: 0.3s;
        }

        #app-indikator .btn-process {
            background: #d97706;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
        }

        #app-indikator .btn-process:hover {
            background: #b45309;
        }

        #app-indikator .btn-copy {
            background: #059669;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        /* FORCE BLACK TEXT ON WHITE BACKGROUND FOR INPUTS */
        #app-indikator input,
        #app-indikator textarea,
        #app-indikator .rh-input {
            color: #000000 !important;
            background-color: #ffffff !important;
            border: 2px solid #fed7aa;
            border-radius: 10px;
            padding: 10px;
            font-family: monospace;
            width: 100%;
            box-sizing: border-box;
        }

        #app-indikator .rh-input {
            height: 150px;
        }

        #app-indikator .result-output {
            width: 100%;
            height: 300px;
            background: #1e293b;
            color: #4ade80;
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            border: none;
            margin-top: 20px;
        }

        /* --- RESPONSIVE SIDEBAR --- */
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            display: block;
            transition: opacity 0.3s;
        }

        /* Close Button inside Sidebar */
        .sidebar-close-btn {
            position: absolute;
            top: 20px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 60;
        }

        .sidebar-close-btn:hover {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Desktop Styles */
        @media (min-width: 769px) {
            .sidebar {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                white-space: nowrap;
                position: relative;
            }

            .sidebar.desktop-hidden {
                width: 0;
                padding: 0;
                overflow: hidden;
                opacity: 0;
                border: none;
            }

            /* HIDE external toggle when sidebar is OPEN */
            #sidebar:not(.desktop-hidden)~.menu-toggle {
                opacity: 0;
                pointer-events: none;
            }

            /* SHOW external toggle when sidebar is HIDDEN */
            #sidebar.desktop-hidden~.menu-toggle {
                opacity: 1;
                pointer-events: auto;
            }
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                height: 100%;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: flex;
            }

            .sidebar.active {
                left: 0;
            }

            /* HIDE external toggle when sidebar is ACTIVE (Open) */
            #sidebar.active~.menu-toggle {
                opacity: 0;
                pointer-events: none;
            }

            .main-content {
                width: 100%;
                padding: 20px;
                padding-top: 80px;
            }
        }
    </style>
</head>

<body>

    <!-- BACKGROUND CANVAS -->
    <canvas id="particle-canvas"></canvas>

    <!-- MOBILE OVERLAY -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <!-- Close Button (Visible when sidebar is Open) -->
        <button class="sidebar-close-btn" onclick="toggleSidebar()">
            <i class="fas fa-times"></i>
        </button>

        <!-- Brand -->
        <div class="brand">
            <!-- Logo without box background -->
            <!-- Logo without box background -->
            <div style="width: 50px; display: flex; align-items: center; justify-content: center;">
                <img src="logo.png" alt="Logo Polda Banten"
                    style="width: 100%; height: auto; animation: pulse-logo 3s infinite;">
            </div>
            <div>
                <h1 class="text-white font-extrabold text-lg leading-tight tracking-wide">BINKAR V1.0</h1>
                <span class="text-amber-400 text-[10px] font-bold tracking-[0.05em] uppercase">Aplikasi Mutjab
                    Banten</span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1">
            <div onclick="switchTab('ukp')" id="nav-ukp" class="nav-link active">
                <i class="fas fa-calculator"></i>
                <span>Hitung UKP</span>
            </div>
            <div onclick="switchTab('validator')" id="nav-validator" class="nav-link">
                <i class="fas fa-check-double"></i>
                <span>Validator Mutasi</span>
            </div>
            <div onclick="switchTab('indikator')" id="nav-indikator" class="nav-link">
                <i class="fas fa-file-invoice"></i>
                <span>Indikator Rh</span>
            </div>
        </nav>

        <!-- Sidebar Footer -->
        <div class="mt-auto pt-6 border-t border-white/5">
            <div class="flex items-center gap-3 bg-white/5 p-3 rounded-xl border border-white/5">
                <div
                    class="w-8 h-8 rounded-full bg-gradient-to-tr from-green-400 to-green-600 flex items-center justify-center text-white text-xs font-bold shadow-lg shadow-green-500/20">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div>
                    <div class="text-xs text-slate-400 font-medium">Status System</div>
                    <div class="text-xs text-green-400 font-bold flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span> Online
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- MENU TOGGLE BTN (Positioned after sidebar for CSS sibling selection) -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- MAIN CONTENT -->
    <main class="main-content">

        <!-- === APP 1: UKP === -->
        <div id="app-ukp" class="app-view active">
            <div class="app-card">
                <div class="header">
                    <h1 style="margin:0; font-size: 24px;">HITUNG UKP POLRI</h1>
                    <p style="margin:8px 0 0; opacity:0.8; font-size:12px;">Berdasarkan Peraturan Kepolisian No. 3 Tahun
                        2016</p>
                </div>

                <div class="content">
                    <div class="form-group">
                        <label>Golongan Personel</label>
                        <select id="golongan" onchange="updateMenu()">
                            <option value="TAMTAMA">TAMTAMA</option>
                            <option value="BINTARA">BINTARA</option>
                            <option value="PERWIRA">PERWIRA</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Pangkat Tujuan</label>
                        <select id="pangkat" onchange="updatePendidikan()"></select>
                    </div>

                    <div id="form-ipda"
                        style="display:none; background:#fffbeb; padding:15px; border-radius:10px; border:1px solid #fcd34d; margin-bottom:20px;">
                        <label>TMT Pangkat IPDA</label>
                        <input type="date" id="tmt_ipda">
                    </div>

                    <div class="form-group">
                        <label>TMT Pangkat Terakhir</label>
                        <input type="date" id="tmt_awal">
                    </div>

                    <div class="form-group">
                        <label>Pendidikan / Dikpol / Dikbang</label>
                        <select id="pendidikan"></select>
                    </div>

                    <button onclick="hitungUKP()">HITUNG KENAIKAN PANGKAT</button>

                    <div id="resultArea"
                        style="display:none; text-align:center; margin-top:20px; padding:20px; background:#f0f9ff; border-radius:15px; border:2px dashed #bae6fd;">
                        <div style="font-size:12px; font-weight:bold; color:#0369a1;">ESTIMASI TMT:</div>
                        <div id="tmt_resmi" style="font-size:28px; font-weight:800; color:#0284c7; margin:5px 0;"></div>
                        <div id="detail_hitung"
                            style="font-size:11px; color:#64748b; background:#e0f2fe; display:inline-block; padding:4px 12px; rounded:20px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === APP 2: VALIDATOR === -->
        <div id="app-validator" class="app-view">
            <div class="glass-card p-0 overflow-hidden">
                <header class="p-6 flex justify-between items-center text-white">
                    <div class="flex items-center gap-4">
                        <div
                            class="icon-box w-12 h-12 rounded-xl flex items-center justify-center text-white text-xl font-bold shadow-lg">
                            <i class="fas fa-fingerprint"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold tracking-wide">VALIDATOR MUTASI</h1>
                            <p class="text-xs text-slate-400 font-medium">Sistem Validasi Personel</p>
                        </div>
                    </div>
                    <button onclick="downloadTemplateCheck()"
                        class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all border border-slate-600">
                        <i class="fas fa-download mr-2"></i> TEMPLATE
                    </button>
                </header>

                <div class="p-8 space-y-8">
                    <!-- Summary Cards -->
                    <div id="summary" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="stat-card bg-slate-50 p-6 rounded-2xl border border-slate-200">
                            <p class="text-xs font-bold text-slate-500 uppercase">Total Data</p>
                            <h2 id="count-total" class="text-3xl font-black text-slate-800">0</h2>
                        </div>
                        <div class="stat-card bg-green-50 p-6 rounded-2xl border border-green-200">
                            <p class="text-xs font-bold text-green-600 uppercase">Data Valid</p>
                            <h2 id="count-valid" class="text-3xl font-black text-green-600">0</h2>
                        </div>
                        <div class="stat-card bg-red-50 p-6 rounded-2xl border border-red-200">
                            <p class="text-xs font-bold text-red-600 uppercase">Data Ganda</p>
                            <h2 id="count-double" class="text-3xl font-black text-red-600">0</h2>
                        </div>
                    </div>

                    <!-- Upload Area -->
                    <div
                        class="border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center hover:border-amber-500 hover:bg-amber-50 transition-all cursor-pointer group relative">
                        <input type="file" id="upload-excel" accept=".xlsx, .xls"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                        <div
                            class="bg-white p-4 rounded-full shadow-lg inline-block mb-4 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cloud-upload-alt text-3xl text-amber-500"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-700">Upload File Excel</h3>
                        <p class="text-sm text-slate-500">Drag & drop atau klik untuk memilih file</p>
                    </div>

                    <!-- Table -->
                    <div class="overflow-hidden rounded-xl border border-slate-200">
                        <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 text-sm">HASIL VALIDASI</h3>
                            <button onclick="exportCleanData()" id="btn-export"
                                class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-xs font-bold">
                                <i class="fas fa-file-export mr-2"></i> EXPORT BERSIH
                            </button>
                        </div>
                        <div class="overflow-x-auto max-h-[400px]">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-100 text-slate-500 sticky top-0">
                                    <tr>
                                        <th class="p-3">No</th>
                                        <th class="p-3">Personel</th>
                                        <th class="p-3">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-body" class="divide-y divide-slate-100">
                                    <tr>
                                        <td colspan="3" class="p-10 text-center text-slate-400 italic">Belum ada data
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === APP 3: INDIKATOR === -->
        <div id="app-indikator" class="app-view">
            <div class="card">
                <h2><i class="fas fa-file-invoice mr-2"></i> INDIKATOR RH</h2>

                <div style="display:grid; gap:20px;">
                    <div>
                        <label>1. CATATAN PERTIMBANGAN (MANUAL)</label>
                        <textarea id="manualPertimbangan" rows="2" placeholder="Contoh: Ybs memiliki dedikasi tinggi..."
                            style="width:100%; padding:10px; border:2px solid #fed7aa; border-radius:8px;"></textarea>
                    </div>

                    <div>
                        <label>2. PASTE TEKS RH DARI SIPP</label>
                        <textarea id="rhInput" class="rh-input"
                            placeholder="Paste seluruh teks RH di sini..."></textarea>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn-process" onclick="prosesData()"><i class="fas fa-cog mr-2"></i>
                            PROSES</button>
                        <button class="btn-copy" onclick="copyResult()"><i class="fas fa-copy mr-2"></i> COPY
                            HASIL</button>
                    </div>

                    <div>
                        <label>HASIL (SIAP COPY)</label>
                        <textarea id="outputArea" class="result-output" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer
            style="margin-top: 40px; padding: 20px; text-align: center; color: rgba(255,255,255,0.4); font-size: 11px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="margin-bottom: 5px; font-weight: 600; letter-spacing: 1px;">
                COPYRIGHT 2026 APLIKASI INTEGRASI MUTJAB BANTEN - TEAM IT BINKAR BANTEN
            </div>
            <div>
                <a href="https://sipp.polri.go.id" target="_blank"
                    style="color: #fbbf24; text-decoration: none; font-weight: bold; transition: 0.3s;">
                    <i class="fas fa-globe mr-1"></i> sipp.polri.go.id
                </a>
            </div>
        </footer>

    </main>

    <!-- JS: PARTICLES + LOGIC -->
    <script>
        // --- PARTICLE BACKGROUND ANIMATION ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = (Math.random() - 0.5) * 0.5;
                this.size = Math.random() * 2 + 1;
                this.color = `rgba(251, 191, 36, ${Math.random() * 0.5 + 0.1})`; // Amber color
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }

        for (let i = 0; i < 80; i++) particles.push(new Particle());

        function animateParticles() {
            ctx.clearRect(0, 0, width, height);

            // Draw connections
            particles.forEach((p, index) => {
                p.update();
                p.draw();

                // Connect nearby particles
                for (let j = index + 1; j < particles.length; j++) {
                    const p2 = particles[j];
                    const dx = p.x - p2.x;
                    const dy = p.y - p2.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 150) {
                        ctx.beginPath();
                        ctx.strokeStyle = `rgba(251, 191, 36, ${0.1 - dist / 1500})`;
                        ctx.lineWidth = 0.5;
                        ctx.moveTo(p.x, p.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                    }
                }
            });
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        // --- SIDEBAR TOGGLE ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            if (window.innerWidth <= 768) {
                // Mobile Logic: Toggle .active to SHOW
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            } else {
                // Desktop Logic: Toggle .desktop-hidden to HIDE
                sidebar.classList.toggle('desktop-hidden');
            }
        }

        // Close sidebar when clicking a menu item on mobile
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });


        // --- DASHBOARD NAVIGATION ---
        function switchTab(tabId) {
            // Hide all apps
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            // Show selected
            const targetApp = document.getElementById('app-' + tabId);
            const targetNav = document.getElementById('nav-' + tabId);

            if (targetApp) targetApp.classList.add('active');
            if (targetNav) targetNav.classList.add('active');
        }

        // --- UKP LOGIC (Minified/Preserved) ---
        const dataPangkat = { TAMTAMA: [{ n: "BHARADA KE BHARATU", m: 60 }, { n: "BHARATU KE BHARAKA", m: 60 }, { n: "BHARAKA KE ABRIPDA", m: 60 }, { n: "ABRIPDA KE ABRIPTU", m: 60 }, { n: "ABRIPTU KE ABRIP", m: 48 }], BINTARA: [{ n: "BRIPDA KE BRIPTU", m: 60 }, { n: "BRIPTU KE BRIGPOL", m: 60 }, { n: "BRIGPOL KE BRIPKA", m: 72 }, { n: "BRIPKA KE AIPDA", m: 72 }, { n: "AIPDA KE AIPTU", m: 60 }], PERWIRA: [{ n: "IPDA KE IPTU", reqIpda: !1, options: [{ l: "REGULER", mdp: 48, mddp: 48 }] }, { n: "IPTU KE AKP", reqIpda: !0, options: [{ l: "REGULER", mdp: 96, mddp: 48 }] }, { l: "AKP KE KOMPOL", reqIpda: !0, options: [{ l: "S2 KEDINASAN / S3 NON KEDINASAN", mdp: 156, mddp: 60 }, { l: "STIK / SESPIMMA / SPESIALIS / PIM TK. III", mdp: 156, mddp: 60 }] }, { n: "KOMPOL KE AKBP", reqIpda: !0, options: [{ l: "SESPIMMEN / S3 KEDINASAN / S2 KEDINASAN YG DISETARAKAN / PIM TK. II", mdp: 204, mddp: 48 }, { l: "S2 KEDINASAN / S3 NON KEDINASAN TERAKREDITASI MIN B", mdp: 228, mddp: 72 }, { l: "STIK / SESPIMMA / SPESIALIS / PIM TK. III", mdp: 252, mddp: 96 }, { l: "S2 NON KEDINASAN TERAKREDITASI MIN B", mdp: 288, mddp: 108 }, { l: "NON DIKBANG", mdp: 324, mddp: 120 }] }, { n: "AKBP KE KOMBES POL", reqIpda: !0, options: [{ l: "SESPIMMEN / S3 KEDINASAN / S2 KEDINASAN YG DISETARAKAN / PIM TK. II", mdp: 252, mddp: 48 }, { l: "S2 KEDINASAN / S3 NON KEDINASAN TERAKREDITASI MIN B", mdp: 324, mddp: 96 }] }, { n: "KOMBES KE DALAM GOLONGAN PATI", reqIpda: !0, options: [{ l: "LEMHANNAS / SESPIMTI / SESKO TNI / PIM TK. I / S3 KEDINASAN YG DISETARAKAN", mdp: 300, mddp: 48 }] }] };
        const opsiBA_TA = [{ t: "REGULER", v: 0 }, { t: "S1 / S2 (POTONG 1 TAHUN)", v: 12 }, { t: "DIKJUR (POTONG 6 BULAN)", v: 6 }, { t: "S1 + DIKJUR", v: 18 }, { t: "S1 + S2 + DIKJUR", v: 30 }];

        function updateMenu() { const e = document.getElementById("golongan").value, t = document.getElementById("pangkat"); t.innerHTML = "", dataPangkat[e].forEach((e, a) => { t.innerHTML += `<option value="${a}">${e.n}</option>` }), updatePendidikan() }
        function updatePendidikan() { const e = document.getElementById("golongan").value, t = document.getElementById("pangkat").value, a = document.getElementById("pendidikan"), n = document.getElementById("form-ipda"); a.innerHTML = "", "PERWIRA" === e ? (dataPangkat.PERWIRA[t].reqIpda ? n.style.display = "block" : n.style.display = "none", dataPangkat.PERWIRA[t].options.forEach((e, t) => { a.innerHTML += `<option value="${t}">${e.l}</option>` })) : (n.style.display = "none", opsiBA_TA.forEach(e => { a.innerHTML += `<option value="${e.v}">${e.t}</option>` })) }
        function hitungUKP() { const e = document.getElementById("golongan").value, t = document.getElementById("tmt_awal").value; if (!t) return alert("Pilih TMT Terakhir!"); let a, n, d = ""; if ("PERWIRA" === e) { const e = document.getElementById("pangkat").value, i = document.getElementById("pendidikan").value, o = dataPangkat.PERWIRA[e], l = o.options[i]; let r = new Date(t); if (r.setMonth(r.getMonth() + l.mddp), r.getDate() < new Date(t).getDate() && r.setDate(0), o.reqIpda) { const e = document.getElementById("tmt_ipda").value; if (!e) return alert("Isi TMT IPDA!"); let t = new Date(e); t.setMonth(t.getMonth() + l.mdp), t.getDate() < new Date(e).getDate() && t.setDate(0), a = new Date(Math.max(t, r)), d = `MDP: ${l.mdp / 12} Th | MDDP: ${l.mddp / 12} Th` } else a = r, d = `MDDP: ${l.mddp / 12} Tahun` } else { const n = document.getElementById("pangkat").value, i = parseInt(document.getElementById("pendidikan").value), o = dataPangkat[e][n].m - i; a = new Date(t), a.setMonth(a.getMonth() + o), a.getDate() < new Date(t).getDate() && a.setDate(0), d = `Masa Dinas: ${o} Bulan` } let i = a.getFullYear(), o = a.getMonth(); n = o <= 1 ? new Date(i, 0, 1) : o >= 2 && o <= 7 ? new Date(i, 6, 1) : new Date(i + 1, 0, 1), document.getElementById("resultArea").style.display = "block", document.getElementById("tmt_resmi").innerText = n.toLocaleDateString("id-ID", { day: "numeric", month: "long", year: "numeric" }).toUpperCase(), document.getElementById("detail_hitung").innerText = d }

        // --- VALIDATOR LOGIC ---
        function downloadTemplateCheck() {
            const template = [["NAMA", "PANGKAT/ NRP/NIP", "JABATAN/KESATUAN BARU"], ["CONTOH NAMA", "12345678", "JABATAN BARU"]];
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Validator");
            XLSX.writeFile(wb, "Template_Validator.xlsx");
        }
        document.getElementById('upload-excel').addEventListener('change', function (e) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const tbody = document.getElementById('preview-body');
                tbody.innerHTML = "";
                let nrpMap = {}, jabMap = {}, dbl = 0, clean = [];

                data.forEach((row, i) => {
                    const no = i + 1, nrp = (row["PANGKAT/ NRP/NIP"] || "").toString().trim(), nama = (row["NAMA"] || "").toUpperCase(), jab = (row["JABATAN/KESATUAN BARU"] || "").toUpperCase();

                    // Normalize: Remove "PS." prefix
                    const normJab = jab.replace(/^PS\.\s*/, "").trim();

                    let errN = "", errJ = "", isD = false;

                    if (nrp && nrpMap[nrp]) {
                        isD = true;
                        errN = `<div class='text-[10px] text-red-600 font-bold mt-1 bg-red-100 p-1 rounded'>NRP SAMA DENGAN NO. URUT ${nrpMap[nrp].no} A.N ${nrpMap[nrp].nama}</div>`;
                    }

                    if (normJab && jabMap[normJab]) {
                        isD = true;
                        errJ = `<div class='text-[10px] text-amber-700 font-bold mt-1 bg-amber-100 p-1 rounded'>JABATAN SAMA DENGAN NO. URUT ${jabMap[normJab].no} A.N ${jabMap[normJab].nama}</div>`;
                    }

                    if (!nrpMap[nrp]) nrpMap[nrp] = { no, nama };
                    if (!jabMap[normJab]) jabMap[normJab] = { no, nama };

                    if (isD) dbl++; else clean.push(row);

                    tbody.innerHTML += `<tr class="${isD ? 'bg-red-50' : 'hover:bg-slate-50'} border-b border-slate-100 transition-colors">
                        <td class="p-3 font-bold text-slate-400 text-center">${no}</td>
                        <td class="p-3">
                            <div class="font-bold text-slate-800 text-xs">${nama}</div>
                            <div class="text-[10px] text-slate-500 bg-slate-100 px-1 rounded inline-block font-mono border border-slate-200">${nrp}</div>
                            <div class="mt-1 text-[10px] italic text-slate-600">${jab}</div>
                        </td>
                        <td class="p-3 align-top">
                            ${!isD ? '<span class="text-green-700 font-bold text-[10px] bg-green-100 px-2 py-1 rounded border border-green-200 shadow-sm"><i class="fas fa-check-circle mr-1"></i> AMAN</span>' : errN + errJ}
                        </td>
                    </tr>`;
                });
                document.getElementById('summary').classList.remove('hidden');
                document.getElementById('count-total').innerText = data.length;
                document.getElementById('count-valid').innerText = data.length - dbl;
                document.getElementById('count-double').innerText = dbl;
                if (clean.length > 0) {
                    document.getElementById('btn-export').classList.remove('hidden');
                    window.cleanData = clean;
                }
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });
        function exportCleanData() {
            const ws = XLSX.utils.json_to_sheet(window.cleanData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Valid");
            XLSX.writeFile(wb, "Data_Valid.xlsx");
        }

        // --- INDIKATOR LOGIC (Preserved) ---
        // --- INDIKATOR LOGIC (Restored from User Source) ---
        function prosesData() {
            const raw = document.getElementById('rhInput').value.toUpperCase();
            if (!raw) return alert("Tempelkan teks RH terlebih dahulu!");

            // --- a. DIKUM (Paling Atas) ---
            let dikum = "-";
            const dikumPart = raw.split("II. PENDIDIKAN UMUM")[1] || "";
            const jenjangs = ["S2", "S1", "D3", "SMA"];
            for (let j of jenjangs) {
                if (dikumPart.split("III.")[0].includes(j)) {
                    dikum = j;
                    break;
                }
            }

            // --- Data Kepolisian (Bagian I) ---
            const sec1 = raw.split("II. PENDIDIKAN UMUM")[0];
            const policeEdu = [];
            const polKeywords = ["AKPOL", "SIPSS", "DIKTUKPA", "DIKTUKBA", "AKABRI", "BRIGADIR", "SEBA", "SIP ", "STIK", "PTIK", "SESPIM", "SIP SUS", "SESPIMMEN", "SESPIMMA"];

            for (let k of polKeywords) {
                const regex = new RegExp(k + ".*?(\\d{4})", "g");
                let m;
                while ((m = regex.exec(sec1)) !== null) {
                    policeEdu.push({ nama: k.trim(), tahun: parseInt(m[1]) });
                }
            }

            // --- b. DIKPOL (Paling Lama) ---
            let dikpol = "-";
            if (policeEdu.length > 0) {
                const tertua = [...policeEdu].sort((a, b) => a.tahun - b.tahun)[0];
                dikpol = tertua.nama + " " + tertua.tahun;
            }

            // --- c. DIKBANG (Paling Baru) ---
            let dikbang = "-";
            if (policeEdu.length > 1) {
                const terbaru = [...policeEdu].sort((a, b) => b.tahun - a.tahun)[0];
                dikbang = terbaru.nama + " " + terbaru.tahun;
            }

            // --- d. DIKJUR (Paling Baru Bagian V) ---
            let dikjur = "-";
            const vPart = raw.split("V. PENDIDIKAN PENGEMBANGAN")[1] || "";
            const jurKeywords = ["SDM", "IDIK", "LANTAS", "REGIDENT", "HUKUM", "TIK", "PROVOS"];
            let foundJur = [];
            for (let k of jurKeywords) {
                const regex = new RegExp(k + ".*?(\\d{4})", "g");
                let m;
                while ((m = regex.exec(vPart)) !== null) {
                    foundJur.push({ n: "DIKBANGSPES " + k, t: parseInt(m[1]) });
                }
            }
            if (foundJur.length > 0) {
                const jurBaru = foundJur.sort((a, b) => b.t - a.t)[0];
                dikjur = jurBaru.n + " " + jurBaru.t;
            }

            // --- e. PENGALAMAN TUGAS ---
            const ivPart = (raw.split("IV. RIWAYAT JABATAN")[1] || "").split("V.")[0];
            const scores = { "SDM": 0, "LANTAS": 0, "RESKRIM": 0, "HUKUM": 0, "SABHARA": 0 };
            if (ivPart.match(/SDM|BINKAR|MUTJAB|DALPERS|DIAPERS|SELEK|PSIKOLOG/g))
                scores["SDM"] = (ivPart.match(/SDM|BINKAR|MUTJAB|DALPERS|DIAPERS|SELEK|PSIKOLOG/g) || []).length;
            if (ivPart.match(/LANTAS|REGIDENT|BPKB|STNK/g))
                scores["LANTAS"] = (ivPart.match(/LANTAS|REGIDENT|BPKB|STNK/g) || []).length;
            if (ivPart.match(/HUKUM|KUM|LUHKUM/g))
                scores["HUKUM"] = (ivPart.match(/HUKUM|KUM|LUHKUM/g) || []).length;
            if (ivPart.match(/RESKRIM|IDIK|RESERSE/g))
                scores["RESKRIM"] = (ivPart.match(/RESKRIM|IDIK|RESERSE/g) || []).length;

            let tugas = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            if (scores[tugas] === 0) tugas = "UMUM";

            // --- f. MDDJ ---
            let mddj = "0 TAHUN 0 BULAN";
            const matchLama = raw.match(/(\d+)\s*TAHUN\s*(\d+)\s*BULAN/i);
            if (matchLama) mddj = matchLama[1] + " TAHUN " + matchLama[2] + " BULAN";

            const pertimbangan = document.getElementById('manualPertimbangan').value || "PERTIMBANGAN ISI MANUAL";

            // FORMATTING BOLD HANYA PADA LABEL
            document.getElementById('outputArea').value = `INDIKATOR PROFESIONALITAS
a. DIKUM: ${dikum}
b. DIKPOL: ${dikpol}
c. DIKBANG: ${dikbang}
d. DIKJUR: ${dikjur}
e. PENGALAMAN TUGAS: ${tugas}
f. MDDJ: ${mddj}

PERTIMBANGAN
${pertimbangan}`;
        }

        function copyResult() {
            const out = document.getElementById('outputArea');
            out.select();
            document.execCommand('copy');
            alert("Berhasil dicopy!");
        }

        // Init
        window.addEventListener('load', () => switchTab('ukp'));
        updateMenu();

    </script>
</body>

</html>
