<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard SDM Polda Banten</title>
    
    <!-- External Dependencies (Combined) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* DASHBOARD SHELL STYLES */
        body { margin: 0; padding: 0; overflow: hidden; }
        .sidebar-link { @apply block py-3 px-4 rounded transition-colors text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white; cursor: pointer; }
        .sidebar-link.active { @apply bg-slate-800 text-white border-l-4 border-blue-500; }
        
        .app-view { display: none; height: 100%; width: 100%; overflow-y: auto; }
        .app-view.active { display: block; }

        /* =========================================
           APP 1: UKP STYLE ISOLATION
           ========================================= */
        #app-ukp {
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); 
            /* Restore Tailwind Preflight resets for this section */
        }
        #app-ukp h1 { font-size: 24px; font-weight: 800; margin-bottom: 0.67em; }
        #app-ukp p { margin-bottom: 1em; }
        #app-ukp :root { --polri-blue: #002D5A; --polri-gold: #FFD700; --accent: #e63946; --bg: #f8f9fa; }

        #app-ukp .app-card { 
            width: 100%; 
            max-width: 550px; 
            background: #ffffff; 
            border-radius: 24px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.15); 
            overflow: hidden; 
            border: 1px solid rgba(0,0,0,0.05);
            margin-bottom: 30px;
            margin-left: auto; margin-right: auto; /* Center it */
        }

        #app-ukp .header { background: #002D5A; color: white; padding: 35px 20px; text-align: center; border-bottom: 5px solid #FFD700; }
        #app-ukp .content { padding: 35px; }
        #app-ukp .form-group { margin-bottom: 22px; }
        
        #app-ukp label { 
            display: block; 
            font-size: 11px; 
            font-weight: 800; 
            color: #002D5A; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }

        #app-ukp select, #app-ukp input { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid #edeff2; 
            border-radius: 12px; 
            font-size: 14px; 
            background: #fbfcfd; 
            transition: 0.3s; 
            box-sizing: border-box; 
            outline: none; 
            font-family: inherit; 
            color: #000;
        }

        #app-ukp select:focus, #app-ukp input:focus { border-color: #002D5A; background: #fff; box-shadow: 0 0 0 4px rgba(0,45,90,0.05); }

        #app-ukp #form-ipda { 
            display: none; 
            background: #fffcf0; 
            padding: 20px; 
            border-radius: 16px; 
            border: 1px solid #f9eeb3; 
            margin-bottom: 22px; 
            animation: slideDown 0.3s ease; 
        }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        #app-ukp button { 
            width: 100%; 
            padding: 18px; 
            background: #002D5A; 
            color: white; 
            border: none; 
            border-radius: 14px; 
            font-weight: 700; 
            font-size: 16px; 
            cursor: pointer; 
            transition: 0.3s; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            box-shadow: 0 4px 15px rgba(0,45,90,0.3); 
        }

        #app-ukp button:hover { background: #004080; transform: translateY(-2px); }

        #app-ukp .result-area { 
            margin-top: 35px; 
            padding: 30px; 
            border-radius: 20px; 
            display: none; 
            text-align: center; 
            background: #f0f7ff; 
            border: 2px dashed #b8daff; 
            animation: fadeIn 0.5s ease; 
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #app-ukp .tmt-final { font-size: 32px; color: #e63946; font-weight: 800; margin: 10px 0; }
        #app-ukp .detail-badge { display: inline-block; padding: 6px 16px; background: #e1efff; color: #0056b3; border-radius: 50px; font-size: 11px; font-weight: 600; margin-top: 10px; }

        #app-ukp footer {
            width: 100%;
            max-width: 550px;
            text-align: center;
            padding: 25px 0;
            color: #4a5568;
            border-top: 2px solid #cbd5e0;
            margin: 0 auto;
        }

        #app-ukp .footer-main {
            font-weight: 800;
            color: #002D5A;
            font-size: 14px;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        #app-ukp .footer-sub {
            font-size: 12px;
            font-weight: 600;
            color: #718096;
            margin-bottom: 12px;
        }

        #app-ukp .copyright {
            font-size: 11px;
            color: #a0aec0;
            font-weight: 400;
        }

        /* =========================================
           APP 2: VALIDATOR STYLE ISOLATION
           ========================================= */
        #app-validator {
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f1f5f9;
        }
        #app-validator .stat-card { transition: transform 0.2s; }
        #app-validator .stat-card:hover { transform: translateY(-5px); }
        #app-validator .row-error { background-color: #fff1f2; border-left: 4px solid #e11d48; }
        #app-validator .row-valid { border-left: 4px solid #10b981; }
        #app-validator .sticky-table-head { position: sticky; top: 0; z-index: 10; background: #1e293b; color: white; }

        /* =========================================
           APP 3: INDIKATOR STYLE ISOLATION
           ========================================= */
        #app-indikator {
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: #e9ecef;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100%; 
            padding: 20px;
        }
        /* Restore Header Sizes */
        #app-indikator h2 { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: #003366; 
            text-align: center; 
            margin-bottom: 25px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }

        #app-indikator .card { width: 100%; max-width: 850px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid #003366; }
        
        #app-indikator label { font-weight: bold; font-size: 13px; color: #555; display: block; margin-bottom: 8px; }
        
        #app-indikator textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-family: 'Consolas', monospace; 
            font-size: 14px; 
            resize: vertical; 
        }
        
        #app-indikator .rh-input { background: #fdfdfd; border: 2px solid #3498db; height: 180px; }
        #app-indikator .result-output { background: #1e272e; color: #0be881; height: 350px; margin-top: 15px; border: none; white-space: pre-wrap; font-size: 15px; }
        
        #app-indikator .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        
        #app-indikator .btn-process { padding: 15px; background: #3498db; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        #app-indikator .btn-process:hover { background: #2980b9; }
        
        #app-indikator .btn-copy { padding: 15px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        #app-indikator .btn-copy:hover { background: #219150; }

    </style>
</head>
<body class="flex h-screen bg-white">

    <!-- 1. SIDEBAR NAVIGATION -->
    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col text-slate-300 shadow-2xl z-20">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold text-white tracking-wider">RO SDM</h1>
            <p class="text-xs text-slate-500 uppercase mt-1">Sistem Integrasi v1.0</p>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <a onclick="switchTab('ukp')" id="nav-ukp" class="sidebar-link active">
                <i class="fas fa-calculator w-6"></i> Hitung UKP
            </a>
            <a onclick="switchTab('validator')" id="nav-validator" class="sidebar-link">
                <i class="fas fa-check-double w-6"></i> Validator Mutasi
            </a>
            <a onclick="switchTab('indikator')" id="nav-indikator" class="sidebar-link">
                <i class="fas fa-file-invoice w-6"></i> Indikator Rh
            </a>
        </nav>

        <div class="p-4 border-t border-slate-800 text-xs text-center text-slate-600">
            &copy; 2026 BAGBINKAR
        </div>
    </aside>

    <!-- 2. MAIN CONTENT AREA -->
    <main class="flex-1 relative bg-gray-50 overflow-hidden">
        
        <!-- === APP 1: UKP === -->
        <div id="app-ukp" class="app-view active" style="padding: 20px; display: flex; flex-direction: column; align-items: center;">
            
            <div class="app-card">
                <div class="header">
                    <h1 style="margin:0; font-size: 24px;">HITUNG UKP POLRI</h1>
                    <p style="margin:8px 0 0; opacity:0.9; font-size:12px;">Berdasarkan Peraturan Kepolisian No. 3 Tahun 2016</p>
                </div>
                
                <div class="content">
                    <div class="form-group">
                        <label>Golongan Personel</label>
                        <select id="golongan" onchange="updateMenu()">
                            <option value="TAMTAMA">TAMTAMA</option>
                            <option value="BINTARA">BINTARA</option>
                            <option value="PERWIRA">PERWIRA</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Pangkat Tujuan</label>
                        <select id="pangkat" onchange="updatePendidikan()"></select>
                    </div>

                    <div id="form-ipda">
                        <label>TMT Pangkat IPDA (Perhatikan Masa Dinas Surut)</label>
                        <input type="date" id="tmt_ipda">
                    </div>

                    <div class="form-group">
                        <label>TMT Pangkat Terakhir</label>
                        <input type="date" id="tmt_awal">
                    </div>

                    <div class="form-group">
                        <label>Pendidikan / Dikpol / Dikbang</label>
                        <select id="pendidikan"></select>
                    </div>

                    <button onclick="hitungUKP()">Hitung Kenaikan Pangkat</button>

                    <div id="resultArea" class="result-area">
                        <div style="font-size: 14px; font-weight: 600; color: #555;">ANDA AKAN NAIK PANGKAT PADA:</div>
                        <div id="tmt_resmi" class="tmt-final"></div>
                        <div id="detail_hitung" class="detail-badge"></div>
                    </div>
                </div>
            </div>

            <footer>
                <div class="footer-main">BAGBINKAR RO SDM POLDA BANTEN</div>
                <div class="footer-sub">Sistem Hitung UKP Polri 1.0</div>
                <div class="copyright">
                    &copy; 2026 • Perpol No. 3 Tahun 2016 • POLRI
                </div>
            </footer>
        </div>

        <!-- === APP 2: VALIDATOR === -->
        <div id="app-validator" class="app-view">
            <!-- Using text-slate-800 from original body -->
            <div class="text-slate-800">
                <header class="bg-[#1e293b] py-6 px-8 shadow-2xl border-b-4 border-red-600">
                    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="bg-red-600 p-3 rounded-xl shadow-lg">
                                <i class="fas fa-fingerprint text-white text-2xl"></i>
                            </div>
                            <div class="text-white">
                                <h1 class="text-xl font-extrabold tracking-tight uppercase">Sistem Validasi Personel</h1>
                                <p class="text-xs text-slate-400 font-medium tracking-widest">BIRO SDM POLDA BANTEN</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="downloadTemplateCheck()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 border border-slate-600">
                                <i class="fas fa-download"></i> UNDUH TEMPLATE
                            </button>
                        </div>
                    </div>
                </header>

                <main class="max-w-7xl mx-auto p-6 md:p-10 space-y-8">
                    
                    <div id="summary" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse-once">
                        <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Total Data Masuk</p>
                            <h2 id="count-total" class="text-4xl font-black text-slate-900">0</h2>
                            <div class="mt-2 text-[10px] text-blue-600 font-bold bg-blue-50 inline-block px-2 py-1 rounded">HASIL IMPORT EXCEL</div>
                        </div>
                        <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-slate-200 border-b-4 border-b-green-500">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Data Unik (Bersih)</p>
                            <h2 id="count-valid" class="text-4xl font-black text-green-600">0</h2>
                            <div class="mt-2 text-[10px] text-green-600 font-bold bg-green-50 inline-block px-2 py-1 rounded">SIAP DIPROSES</div>
                        </div>
                        <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-slate-200 border-b-4 border-b-red-500">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Data Ganda (Double)</p>
                            <h2 id="count-double" class="text-4xl font-black text-red-600">0</h2>
                            <div class="mt-2 text-[10px] text-red-600 font-bold bg-red-50 inline-block px-2 py-1 rounded">PERLU PERBAIKAN</div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-200 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-5">
                            <i class="fas fa-file-excel text-9xl"></i>
                        </div>
                        
                        <div class="max-w-xl">
                            <h3 class="text-lg font-bold text-slate-800 mb-2">Unggah Data Personel</h3>
                            <p class="text-sm text-slate-500 mb-6">Pastikan file Excel Anda menggunakan format Nama, NRP, dan Jabatan Baru yang sesuai template.</p>
                            
                            <label class="group relative flex items-center justify-between p-4 bg-slate-50 border-2 border-dashed border-slate-300 rounded-2xl hover:border-red-500 hover:bg-red-50 transition-all cursor-pointer">
                                <div class="flex items-center gap-4">
                                    <div class="bg-white p-3 rounded-xl shadow-sm group-hover:scale-110 transition-transform">
                                        <i class="fas fa-upload text-red-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <span class="block text-sm font-bold text-slate-700">Pilih File Analisis</span>
                                        <span class="text-[10px] text-slate-400">Excel (.xlsx atau .xls)</span>
                                    </div>
                                </div>
                                <input type="file" id="upload-excel" accept=".xlsx, .xls" class="hidden"/>
                                <span class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold">BROWSE</span>
                            </label>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50">
                            <div>
                                <h3 class="font-bold text-slate-800 uppercase tracking-widest text-sm italic">Review Hasil Pemeriksaan</h3>
                            </div>
                            <button onclick="exportCleanData()" id="btn-export" class="hidden bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg shadow-green-200 flex items-center gap-2 transition-all">
                                <i class="fas fa-check-double"></i> SIMPAN DATA BERSIH
                            </button>
                        </div>

                        <div class="overflow-x-auto overflow-y-auto max-h-[500px]">
                            <table class="w-full text-left">
                                <thead class="sticky-table-head">
                                    <tr class="text-[10px] uppercase tracking-widest">
                                        <th class="p-4 text-center">No</th>
                                        <th class="p-4">Personel & Jabatan</th>
                                        <th class="p-4">Status & Identifikasi Ganda</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-body" class="text-xs divide-y divide-slate-100">
                                    <tr>
                                        <td colspan="3" class="p-20 text-center text-slate-400">
                                            <i class="fas fa-clipboard-list text-5xl mb-4 block opacity-10"></i>
                                            <span class="font-medium">Belum ada data untuk diperiksa</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- === APP 3: INDIKATOR === -->
        <div id="app-indikator" class="app-view">
            <div class="card">
                <h2>Indikator Profesionalitas</h2>
                
                <label>1. MASUKKAN PERTIMBANGAN (MANUAL):</label>
                <textarea id="manualPertimbangan" rows="2" placeholder="Ketik Nota Dinas di sini..."></textarea>

                <label style="margin-top:15px;">2. PASTE TEKS RIWAYAT HIDUP (RH) DI SINI:</label>
                <textarea id="rhInput" class="rh-input" placeholder="Tempelkan teks RH di sini..."></textarea>
                
                <div class="btn-group">
                    <button class="btn-process" onclick="prosesData()">PROSES DATA</button>
                    <button class="btn-copy" onclick="copyResult()">COPY HASIL</button>
                </div>

                <label>HASIL SIAP COPY:</label>
                <textarea id="outputArea" class="result-output" readonly></textarea>
            </div>
        </div>

    </main>

    <!-- COMBINED SCRIPTS -->
    <script>
        // === DASHBOARD LOGIC ===
        function switchTab(tabId) {
            // Hide all apps
            document.querySelectorAll('.app-view').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none'; // Ensure explicit hide
                if(tabId === 'ukp' && el.id === 'app-ukp') el.style.display = 'flex'; // UKP uses flex in style attribute
                if(tabId === 'indikator' && el.id === 'app-indikator') el.style.display = 'flex'; // Indikator uses flex in style attribute
                if(tabId === 'validator' && el.id === 'app-validator') el.style.display = 'block';
            });
            
            // Show selected app
            // Note: The classes/styles handle 'active', but I'll reinforce for safety
            
            // Reset Sidebar
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
        }

        // Initialize default tab (UKP) on load
        window.addEventListener('load', () => {
            switchTab('ukp');
        });

        // === APP 1: UKP LOGIC ===
        const dataPangkat = {
            TAMTAMA: [
                { n: "BHARADA KE BHARATU", m: 60 }, { n: "BHARATU KE BHARAKA", m: 60 },
                { n: "BHARAKA KE ABRIPDA", m: 60 }, { n: "ABRIPDA KE ABRIPTU", m: 60 },
                { n: "ABRIPTU KE ABRIP", m: 48 }
            ],
            BINTARA: [
                { n: "BRIPDA KE BRIPTU", m: 60 }, { n: "BRIPTU KE BRIGPOL", m: 60 },
                { n: "BRIGPOL KE BRIPKA", m: 72 }, { n: "BRIPKA KE AIPDA", m: 72 },
                { n: "AIPDA KE AIPTU", m: 60 }
            ],
            PERWIRA: [
                { n: "IPDA KE IPTU", reqIpda: false, options: [{l: "REGULER", mdp: 48, mddp: 48}] },
                { n: "IPTU KE AKP", reqIpda: true, options: [{l: "REGULER", mdp: 96, mddp: 48}] },
                { n: "AKP KE KOMPOL", reqIpda: true, options: [
                    {l: "S2 KEDINASAN / S3 NON KEDINASAN", mdp: 156, mddp: 60},
                    {l: "STIK / SESPIMMA / SPESIALIS / PIM TK. III", mdp: 156, mddp: 60}
                ]},
                { n: "KOMPOL KE AKBP", reqIpda: true, options: [
                    {l: "SESPIMMEN / S3 KEDINASAN / S2 KEDINASAN YG DISETARAKAN / PIM TK. II", mdp: 204, mddp: 48},
                    {l: "S2 KEDINASAN / S3 NON KEDINASAN TERAKREDITASI MIN B", mdp: 228, mddp: 72},
                    {l: "STIK / SESPIMMA / SPESIALIS / PIM TK. III", mdp: 252, mddp: 96},
                    {l: "S2 NON KEDINASAN TERAKREDITASI MIN B", mdp: 288, mddp: 108},
                    {l: "NON DIKBANG", mdp: 324, mddp: 120}
                ]},
                { n: "AKBP KE KOMBES POL", reqIpda: true, options: [
                    {l: "SESPIMMEN / S3 KEDINASAN / S2 KEDINASAN YG DISETARAKAN / PIM TK. II", mdp: 252, mddp: 48},
                    {l: "S2 KEDINASAN / S3 NON KEDINASAN TERAKREDITASI MIN B", mdp: 324, mddp: 96}
                ]},
                { n: "KOMBES KE DALAM GOLONGAN PATI", reqIpda: true, options: [
                    {l: "LEMHANNAS / SESPIMTI / SESKO TNI / PIM TK. I / S3 KEDINASAN YG DISETARAKAN", mdp: 300, mddp: 48}
                ]}
            ]
        };

        const opsiBA_TA = [
            { t: "REGULER", v: 0 },
            { t: "S1 / S2 (POTONG 1 TAHUN)", v: 12 },
            { t: "DIKJUR (POTONG 6 BULAN)", v: 6 },
            { t: "S1 + DIKJUR", v: 18 },
            { t: "S1 + S2 + DIKJUR", v: 30 }
        ];

        function updateMenu() {
            const gol = document.getElementById('golongan').value;
            const pSel = document.getElementById('pangkat');
            pSel.innerHTML = "";
            dataPangkat[gol].forEach((p, idx) => pSel.innerHTML += `<option value="${idx}">${p.n}</option>`);
            updatePendidikan();
        }

        function updatePendidikan() {
            const gol = document.getElementById('golongan').value;
            const pIdx = document.getElementById('pangkat').value;
            const pcSel = document.getElementById('pendidikan');
            const ipdaDiv = document.getElementById('form-ipda');
            pcSel.innerHTML = "";

            if (gol === 'PERWIRA') {
                const pData = dataPangkat.PERWIRA[pIdx];
                ipdaDiv.style.display = pData.reqIpda ? 'block' : 'none';
                pData.options.forEach((o, i) => pcSel.innerHTML += `<option value="${i}">${o.l}</option>`);
            } else {
                ipdaDiv.style.display = 'none';
                opsiBA_TA.forEach(o => pcSel.innerHTML += `<option value="${o.v}">${o.t}</option>`);
            }
        }

        function hitungUKP() {
            const gol = document.getElementById('golongan').value;
            const tmtAwal = document.getElementById('tmt_awal').value;
            if (!tmtAwal) return alert("Silakan pilih TMT Pangkat Terakhir!");

            let finalRaw;
            let detail = "";

            if (gol === 'PERWIRA') {
                const pIdx = document.getElementById('pangkat').value;
                const edIdx = document.getElementById('pendidikan').value;
                const pData = dataPangkat.PERWIRA[pIdx];
                const syarat = pData.options[edIdx];

                let targetMDDP = new Date(tmtAwal);
                targetMDDP.setMonth(targetMDDP.getMonth() + syarat.mddp);
                if (targetMDDP.getDate() < new Date(tmtAwal).getDate()) targetMDDP.setDate(0);

                if (pData.reqIpda) {
                    const tmtIpda = document.getElementById('tmt_ipda').value;
                    if (!tmtIpda) return alert("Wajib mengisi TMT IPDA untuk validasi MDP!");
                    let targetMDP = new Date(tmtIpda);
                    targetMDP.setMonth(targetMDP.getMonth() + syarat.mdp);
                    if (targetMDP.getDate() < new Date(tmtIpda).getDate()) targetMDP.setDate(0);
                    
                    finalRaw = new Date(Math.max(targetMDP, targetMDDP));
                    detail = `MDP: ${syarat.mdp/12} Thn | MDDP: ${syarat.mddp/12} Thn`;
                } else {
                    finalRaw = targetMDDP;
                    detail = `MDDP: ${syarat.mddp/12} Tahun`;
                }
            } else {
                const pIdx = document.getElementById('pangkat').value;
                const potong = parseInt(document.getElementById('pendidikan').value);
                let mddp = dataPangkat[gol][pIdx].m - potong;
                finalRaw = new Date(tmtAwal);
                finalRaw.setMonth(finalRaw.getMonth() + mddp);
                if (finalRaw.getDate() < new Date(tmtAwal).getDate()) finalRaw.setDate(0);
                detail = `Masa Dinas: ${mddp} Bulan`;
            }

            // Logika Windowing & Penarikan Feb ke Jan
            let y = finalRaw.getFullYear(), m = finalRaw.getMonth();
            let tmtResmi = (m <= 1) ? new Date(y, 0, 1) : (m >= 2 && m <= 7) ? new Date(y, 6, 1) : new Date(y + 1, 0, 1);

            document.getElementById('resultArea').style.display = "block";
            document.getElementById('tmt_resmi').innerText = tmtResmi.toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'}).toUpperCase();
            document.getElementById('detail_hitung').innerText = detail;
        }

        // Initialize UKP Menu
        updateMenu();

        // === APP 2: VALIDATOR LOGIC ===
        let cleanData = [];

        function downloadTemplateCheck() {
            const template = [
                ["NAMA", "PANGKAT/ NRP/NIP", "JABATAN/KESATUAN BARU"],
                ["BAGUS YOGA ILHAM PRIBADI, S.Tr.K.", "00051109", "PAMA POLRESTA SERANG KOTA"],
                ["RAHMAT WIGUNA, S.H., M.H.", "89050124", "PS. PANIT 1 UNIT 3 SUBDIT 1 DITRESKRIMUM"]
            ];
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Validator");
            XLSX.writeFile(wb, "Template_Validator_SDM.xlsx");
        }

        document.getElementById('upload-excel').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                cekValidasi(data);
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function cekValidasi(data) {
            const tbody = document.getElementById('preview-body');
            tbody.innerHTML = "";
            cleanData = [];
            
            let nrpTracker = {}; 
            let jabatanTracker = {}; 
            let doubleCount = 0;

            data.forEach((row, index) => {
                const no = index + 1;
                const nrp = (row["PANGKAT/ NRP/NIP"] || "").toString().trim();
                const nama = (row["NAMA"] || "").toUpperCase();
                const jabBaru = (row["JABATAN/KESATUAN BARU"] || "").toUpperCase();
                
                let isDouble = false;
                let errorNRP = "";
                let errorJab = "";

                if (nrp !== "" && nrpTracker[nrp]) {
                    isDouble = true;
                    errorNRP = `<div class='mt-1 bg-red-600 text-white p-2 rounded-lg text-[10px] shadow-sm'>
                                    <i class='fas fa-exclamation-triangle'></i> NRP SAMA DENGAN: <b>No. ${nrpTracker[nrp].no} - ${nrpTracker[nrp].nama}</b>
                                </div>`;
                }

                if (jabBaru !== "" && jabatanTracker[jabBaru]) {
                    isDouble = true;
                    errorJab = `<div class='mt-1 bg-orange-600 text-white p-2 rounded-lg text-[10px] shadow-sm'>
                                    <i class='fas fa-user-friends'></i> JABATAN SUDAH DIISI: <b>No. ${jabatanTracker[jabBaru].no} - ${jabatanTracker[jabBaru].nama}</b>
                                </div>`;
                }

                if (!nrpTracker[nrp]) nrpTracker[nrp] = { no, nama };
                if (!jabatanTracker[jabBaru]) jabatanTracker[jabBaru] = { no, nama };

                if (!isDouble) cleanData.push(row); else doubleCount++;

                const tr = document.createElement('tr');
                tr.className = isDouble ? 'row-error' : 'row-valid hover:bg-slate-50 transition-colors';
                
                tr.innerHTML = `
                    <td class="p-5 text-center font-bold text-slate-400">${no}</td>
                    <td class="p-5">
                        <div class="font-bold text-slate-900 text-sm mb-1">${nama}</div>
                        <div class="flex items-center gap-2 text-[10px] text-slate-500 mb-2">
                            <span class="bg-slate-200 px-2 py-0.5 rounded font-bold">${nrp}</span>
                        </div>
                        <div class="text-[11px] bg-slate-100 p-2 rounded border border-slate-200 text-slate-700 italic">
                            ${jabBaru}
                        </div>
                    </td>
                    <td class="p-5">
                        ${!isDouble ? '<span class="text-green-600 font-bold bg-green-50 px-3 py-1 rounded-full"><i class="fas fa-check-circle"></i> DATA AMAN</span>' : ''}
                        ${errorNRP}
                        ${errorJab}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('summary').classList.remove('hidden');
            document.getElementById('count-total').innerText = data.length;
            document.getElementById('count-valid').innerText = data.length - doubleCount;
            document.getElementById('count-double').innerText = doubleCount;
            document.getElementById('btn-export').classList.remove('hidden');
        }

        function exportCleanData() {
            const ws = XLSX.utils.json_to_sheet(cleanData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ValidData");
            XLSX.writeFile(wb, "Data_Mutasi_SDM_Final.xlsx");
        }

        // === APP 3: INDIKATOR LOGIC ===
        function prosesData() {
            const raw = document.getElementById('rhInput').value.toUpperCase();
            if (!raw) return alert("Tempelkan teks RH terlebih dahulu!");

            // --- a. DIKUM (Paling Atas) ---
            let dikum = "-";
            const dikumPart = raw.split("II. PENDIDIKAN UMUM")[1] || "";
            const jenjangs = ["S2", "S1", "D3", "SMA"];
            for (let j of jenjangs) {
                if (dikumPart.split("III.")[0].includes(j)) {
                    dikum = j;
                    break;
                }
            }

            // --- Data Kepolisian (Bagian I) ---
            const sec1 = raw.split("II. PENDIDIKAN UMUM")[0];
            const policeEdu = [];
            const polKeywords = ["AKPOL", "SIPSS", "DIKTUKPA", "DIKTUKBA", "AKABRI", "BRIGADIR", "SEBA", "SIP ", "STIK", "PTIK", "SESPIM", "SIP SUS", "SESPIMMEN", "SESPIMMA"];
            
            for (let k of polKeywords) {
                const regex = new RegExp(k + ".*?(\\d{4})", "g");
                let m;
                while ((m = regex.exec(sec1)) !== null) {
                    policeEdu.push({ nama: k.trim(), tahun: parseInt(m[1]) });
                }
            }

            // --- b. DIKPOL (Paling Lama) ---
            let dikpol = "-";
            if (policeEdu.length > 0) {
                const tertua = [...policeEdu].sort((a,b) => a.tahun - b.tahun)[0];
                dikpol = tertua.nama + " " + tertua.tahun;
            }

            // --- c. DIKBANG (Paling Baru) ---
            let dikbang = "-";
            if (policeEdu.length > 1) {
                const terbaru = [...policeEdu].sort((a,b) => b.tahun - a.tahun)[0];
                dikbang = terbaru.nama + " " + terbaru.tahun;
            }

            // --- d. DIKJUR (Paling Baru Bagian V) ---
            let dikjur = "-";
            const vPart = raw.split("V. PENDIDIKAN PENGEMBANGAN")[1] || "";
            const jurKeywords = ["SDM", "IDIK", "LANTAS", "REGIDENT", "HUKUM", "TIK", "PROVOS"];
            let foundJur = [];
            for (let k of jurKeywords) {
                const regex = new RegExp(k + ".*?(\\d{4})", "g");
                let m;
                while ((m = regex.exec(vPart)) !== null) {
                    foundJur.push({ n: "DIKBANGSPES " + k, t: parseInt(m[1]) });
                }
            }
            if (foundJur.length > 0) {
                const jurBaru = foundJur.sort((a,b) => b.t - a.t)[0];
                dikjur = jurBaru.n + " " + jurBaru.t;
            }

            // --- e. PENGALAMAN TUGAS ---
            const ivPart = (raw.split("IV. RIWAYAT JABATAN")[1] || "").split("V.")[0];
            const scores = { "SDM": 0, "LANTAS": 0, "RESKRIM": 0, "HUKUM": 0, "SABHARA": 0 };
            if (ivPart.match(/SDM|BINKAR|MUTJAB|DALPERS|DIAPERS|SELEK|PSIKOLOG/g)) 
                scores["SDM"] = (ivPart.match(/SDM|BINKAR|MUTJAB|DALPERS|DIAPERS|SELEK|PSIKOLOG/g) || []).length;
            if (ivPart.match(/LANTAS|REGIDENT|BPKB|STNK/g)) 
                scores["LANTAS"] = (ivPart.match(/LANTAS|REGIDENT|BPKB|STNK/g) || []).length;
            if (ivPart.match(/HUKUM|KUM|LUHKUM/g)) 
                scores["HUKUM"] = (ivPart.match(/HUKUM|KUM|LUHKUM/g) || []).length;
            if (ivPart.match(/RESKRIM|IDIK|RESERSE/g)) 
                scores["RESKRIM"] = (ivPart.match(/RESKRIM|IDIK|RESERSE/g) || []).length;

            let tugas = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            if (scores[tugas] === 0) tugas = "UMUM";

            // --- f. MDDJ ---
            let mddj = "0 TAHUN 0 BULAN";
            const matchLama = raw.match(/(\d+)\s*TAHUN\s*(\d+)\s*BULAN/i);
            if (matchLama) mddj = matchLama[1] + " TAHUN " + matchLama[2] + " BULAN";

            const pertimbangan = document.getElementById('manualPertimbangan').value || "PERTIMBANGAN ISI MANUAL";

            // FORMATTING BOLD HANYA PADA LABEL
            document.getElementById('outputArea').value = `INDIKATOR PROFESIONALITAS
a. DIKUM: ${dikum}
b. DIKPOL: ${dikpol}
c. DIKBANG: ${dikbang}
d. DIKJUR: ${dikjur}
e. PENGALAMAN TUGAS: ${tugas}
f. MDDJ: ${mddj}

PERTIMBANGAN
${pertimbangan}`;
        }

        function copyResult() {
            const out = document.getElementById('outputArea');
            out.select();
            document.execCommand('copy');
            alert("Berhasil dicopy!");
        }
    </script>
</body>
</html>
